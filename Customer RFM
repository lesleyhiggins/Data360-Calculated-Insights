SELECT sub2.Unified_Individual_Id__c as Unified_Individual_Id__c, FIRST( sub2.RFM_Monetary__c * 100 + sub2.RFM_Monetary__c * 10 + sub2.RFM_Recency__c ) as RFM_Combined__c, FIRST(sub2.RFM_Monetary__c) as Monetary__c, FIRST(sub2.RFM_Frequency__c) as Frequency__c, FIRST(sub2.RFM_Recency__c) as Recency__c FROM ( SELECT UnifiedIndividual__dlm.ssot__Id__c as Unified_Individual_Id__c, ntile(5) over ( order by AVG(ssot__SalesOrder__dlm.Subtotal_Amount__c) ) as RFM_Monetary__c, ntile(5) over ( order by COUNT(ssot__SalesOrder__dlm.ssot__Id__c) ) as RFM_Frequency__c, ntile(5) over ( order by MAX(ssot__SalesOrder__dlm.ssot__CreatedDate__c) ) as RFM_Recency__c FROM ssot__SalesOrder__dlm LEFT OUTER JOIN IndividualIdentityLink__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = IndividualIdentityLink__dlm.SourceRecordId__c LEFT OUTER JOIN UnifiedIndividual__dlm ON UnifiedIndividual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.UnifiedRecordId__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c ) as sub2 GROUP BY sub2.Unified_Individual_Id__c
