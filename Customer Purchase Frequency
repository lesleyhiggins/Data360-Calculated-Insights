SELECT COUNT(ssot__SalesOrder__dlm.ssot__Id__c) AS total_orders_all_time__c, COUNT(CASE WHEN ssot__SalesOrder__dlm.ssot__CreatedDate__c >= DATE_SUB(CURRENT_DATE(), 180) THEN ssot__SalesOrder__dlm.ssot__Id__c END) AS total_orders_last_6_months__c, COUNT(CASE WHEN ssot__SalesOrder__dlm.ssot__CreatedDate__c >= DATE_SUB(CURRENT_DATE(), 365) THEN ssot__SalesOrder__dlm.ssot__Id__c END) AS total_orders_last_12_months__c, MAX(ssot__SalesOrder__dlm.ssot__CreatedDate__c) AS last_purchase_date__c, MIN(ssot__SalesOrder__dlm.ssot__CreatedDate__c) AS first_purchase_date__c, DATEDIFF(CURRENT_DATE(), MAX(ssot__SalesOrder__dlm.ssot__CreatedDate__c)) AS days_since_last_purchase__c, DATEDIFF(CURRENT_DATE(), MIN(ssot__SalesOrder__dlm.ssot__CreatedDate__c)) AS days_since_first_purchase__c, UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id__c FROM ssot__SalesOrder__dlm JOIN ssot__Individual__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = ssot__Individual__dlm.ssot__Id__c AND ssot__SalesOrder__dlm.KQ_SoldToCustomerId__c = ssot__Individual__dlm.KQ_Id__c JOIN IndividualIdentityLink__dlm ON ssot__Individual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.SourceRecordId__c AND ssot__Individual__dlm.KQ_Id__c = IndividualIdentityLink__dlm.KQ_SourceRecordId__c JOIN UnifiedIndividual__dlm ON IndividualIdentityLink__dlm.UnifiedRecordId__c = UnifiedIndividual__dlm.ssot__Id__c WHERE ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'RETURN%' AND ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'REFUND%' GROUP BY unified_individual_id__c
