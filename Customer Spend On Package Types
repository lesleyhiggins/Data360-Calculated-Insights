SELECT UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id__c, order_package_data.total_can_amount AS spend_on_can__c, order_package_data.total_pouch_amount AS spend_on_pouch__c, order_package_data.total_cup_amount AS spend_on_cup__c, order_package_data.total_bag_amount AS spend_on_bag__c, ( order_package_data.total_can_amount / order_package_data.total_amount ) * 100 AS pct_spend_on_can__c, ( order_package_data.total_pouch_amount / order_package_data.total_amount ) * 100 AS pct_spend_on_pouch__c, ( order_package_data.total_cup_amount / order_package_data.total_amount ) * 100 AS pct_spend_on_cup__c, ( order_package_data.total_bag_amount / order_package_data.total_amount ) * 100 AS pct_spend_on_bag__c, ( order_package_data.total_other_amount / order_package_data.total_amount ) * 100 AS pct_spend_on_other__c, COUNT(ssot__Individual__dlm.ssot__Id__c) AS total_individual_count__c FROM UnifiedIndividual__dlm JOIN IndividualIdentityLink__dlm ON UnifiedIndividual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.UnifiedRecordId__c JOIN ssot__Individual__dlm ON IndividualIdentityLink__dlm.SourceRecordId__c = ssot__Individual__dlm.ssot__Id__c LEFT OUTER JOIN ( SELECT UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE '%Can%' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_can_amount, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE '%Pouch%' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_pouch_amount, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE '%Cup%' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_cup_amount, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE '%Bag%' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_bag_amount, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c NOT LIKE '%Bag%' AND ssot__Product__dlm.Store_Tags__c NOT LIKE '%Cup%' AND ssot__Product__dlm.Store_Tags__c NOT LIKE '%Pouch%' AND ssot__Product__dlm.Store_Tags__c NOT LIKE '%Can%' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_other_amount, SUM( ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ) AS total_amount FROM ssot__SalesOrderProduct__dlm JOIN ssot__Product__dlm ON ssot__SalesOrderProduct__dlm.ssot__ProductId__c = ssot__Product__dlm.ssot__Id__c JOIN ssot__SalesOrder__dlm ON ssot__SalesOrder__dlm.ssot__Id__c = ssot__SalesOrderProduct__dlm.ssot__SalesOrderId__c JOIN ssot__Individual__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = ssot__Individual__dlm.ssot__Id__c JOIN IndividualIdentityLink__dlm ON ssot__Individual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.SourceRecordId__c JOIN UnifiedIndividual__dlm ON IndividualIdentityLink__dlm.UnifiedRecordId__c = UnifiedIndividual__dlm.ssot__Id__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c ) AS order_package_data ON order_package_data.unified_individual_id = UnifiedIndividual__dlm.ssot__Id__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c, order_package_data.total_can_amount, order_package_data.total_pouch_amount, order_package_data.total_cup_amount, order_package_data.total_bag_amount, pct_spend_on_bag__c, pct_spend_on_can__c, pct_spend_on_cup__c, pct_spend_on_pouch__c, pct_spend_on_other__c
