SELECT COUNT(CASE WHEN ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'RETURN%' AND ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'REFUND%' THEN ssot__SalesOrder__dlm.ssot__Id__c END) AS total_orders__c, SUM(ssot__SalesOrder__dlm.Subtotal_Amount__c) AS total_spend__c, (SUM(ssot__SalesOrder__dlm.Total_Discount_Amount__c)) AS total_discounted_spend__c, (( SUM(ssot__SalesOrder__dlm.Total_Discount_Amount__c) / SUM(ssot__SalesOrder__dlm.Subtotal_Amount__c) ) * 100) AS discounted_spend_pct__c, (SUM(ssot__SalesOrder__dlm.Subtotal_Amount__c) / COUNT(CASE WHEN ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'RETURN%' AND ssot__SalesOrder__dlm.ssot__Name__c NOT LIKE 'REFUND%' THEN ssot__SalesOrder__dlm.ssot__Id__c END)) AS avg_order_value__c, UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id__c FROM ssot__SalesOrder__dlm JOIN ssot__Individual__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = ssot__Individual__dlm.ssot__Id__c JOIN IndividualIdentityLink__dlm ON ssot__Individual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.SourceRecordId__c JOIN UnifiedIndividual__dlm ON IndividualIdentityLink__dlm.UnifiedRecordId__c = UnifiedIndividual__dlm.ssot__Id__c WHERE (ssot__SalesOrder__dlm.ssot__CreatedDate__c >= date_sub(current_date(), 180)) GROUP BY unified_individual_id__c
