SELECT UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id__c, pet_data.total_cats AS total_cats__c, pet_data.total_dogs AS total_dogs__c, pet_order_data.total_cat_amount AS total_cat_amount__c, pet_order_data.total_dog_amount AS total_dog_amount__c, pet_order_data.total_cat_amount / pet_data.total_cats AS avg_cat_amount__c, pet_order_data.total_dog_amount / pet_data.total_dogs AS avg_dog_amount__c, SUM(ssot__SalesOrder__dlm.ssot__TotalAmount__c) AS order_total_amount__c FROM UnifiedIndividual__dlm JOIN IndividualIdentityLink__dlm ON UnifiedIndividual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.UnifiedRecordId__c JOIN ssot__Individual__dlm ON IndividualIdentityLink__dlm.SourceRecordId__c = ssot__Individual__dlm.ssot__Id__c JOIN ssot__SalesOrder__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = ssot__Individual__dlm.ssot__Id__c LEFT OUTER JOIN ( SELECT UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE 'Cat,%' OR ssot__Product__dlm.Store_Tags__c LIKE '%, Cat,%' OR ssot__Product__dlm.Store_Tags__c LIKE '%, Cat' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_cat_amount, SUM( CASE WHEN ssot__Product__dlm.Store_Tags__c LIKE 'Dog,%' OR ssot__Product__dlm.Store_Tags__c LIKE '%, Dog,%' OR ssot__Product__dlm.Store_Tags__c LIKE '%, Dog' THEN ssot__SalesOrderProduct__dlm.ssot__TotalPriceAmount__c ELSE 0 END ) AS total_dog_amount FROM ssot__SalesOrderProduct__dlm JOIN ssot__Product__dlm ON ssot__SalesOrderProduct__dlm.ssot__ProductId__c = ssot__Product__dlm.ssot__Id__c JOIN ssot__SalesOrder__dlm ON ssot__SalesOrder__dlm.ssot__Id__c = ssot__SalesOrderProduct__dlm.ssot__SalesOrderId__c JOIN ssot__Individual__dlm ON ssot__SalesOrder__dlm.ssot__SoldToCustomerId__c = ssot__Individual__dlm.ssot__Id__c JOIN IndividualIdentityLink__dlm ON ssot__Individual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.SourceRecordId__c JOIN UnifiedIndividual__dlm ON IndividualIdentityLink__dlm.UnifiedRecordId__c = UnifiedIndividual__dlm.ssot__Id__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c ) AS pet_order_data ON pet_order_data.unified_individual_id = UnifiedIndividual__dlm.ssot__Id__c LEFT OUTER JOIN ( SELECT SUM( CASE WHEN Pet_Profile__dlm.Type__c = 'Cat' THEN 1 ELSE 0 END ) AS total_cats, SUM( CASE WHEN Pet_Profile__dlm.Type__c = 'Dog' THEN 1 ELSE 0 END ) AS total_dogs, UnifiedIndividual__dlm.ssot__Id__c AS unified_individual_id FROM UnifiedIndividual__dlm JOIN IndividualIdentityLink__dlm ON UnifiedIndividual__dlm.ssot__Id__c = IndividualIdentityLink__dlm.UnifiedRecordId__c JOIN ssot__Individual__dlm ON IndividualIdentityLink__dlm.SourceRecordId__c = ssot__Individual__dlm.ssot__Id__c LEFT OUTER JOIN Pet_Profile__dlm ON ssot__Individual__dlm.ssot__Id__c = Pet_Profile__dlm.Party__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c ) AS pet_data ON pet_data.unified_individual_id = UnifiedIndividual__dlm.ssot__Id__c GROUP BY UnifiedIndividual__dlm.ssot__Id__c, pet_data.total_cats, pet_data.total_dogs, pet_order_data.total_cat_amount, pet_order_data.total_dog_amount, avg_cat_amount__c, avg_dog_amount__c
